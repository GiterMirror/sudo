#*
#* CU sudo version 1.3.6 (based on Root Group sudo version 1.1)
#*
#* This software comes with no waranty whatsoever, use at your own risk.
#*
#* Please send bugs, changes, problems to sudo-bugs@cs.colorado.edu
#*

#*  sudo version 1.1 allows users to execute commands as root
#*  Copyright (C) 1991  The Root Group, Inc.
#*
#*  This program is free software; you can redistribute it and/or modify
#*  it under the terms of the GNU General Public License as published by
#*  the Free Software Foundation; either version 1, or (at your option)
#*  any later version.
#*
#*  This program is distributed in the hope that it will be useful,
#*  but WITHOUT ANY WARRANTY; without even the implied warranty of
#*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#*  GNU General Public License for more details.
#*
#*  You should have received a copy of the GNU General Public License
#*  along with this program; if not, write to the Free Software
#*  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#*
#* @configure_input@
#*

#### Start of system configuration section. ####

srcdir = @srcdir@
VPATH = @srcdir@

# Compiler & tools to use
CC = @CC@
LEX = @LEX@
YACC = @YACC@
NROFF = nroff

# Which install program?
INSTALL = @INSTALL@

# Libraries
SUDO_LIBS = @LEXLIB@ @SUDO_LIBS@
VISUDO_LIBS = @LEXLIB@ @VISUDO_LIBS@

# OS defines
OSDEFS = @OSDEFS@

# C preprocessor flags
CPPFLAGS = -I. -I$(srcdir) @CPPFLAGS@

# Usually -g or -O
CFLAGS = @CFLAGS@

# Flags to pass to the link stage
SUDO_LDFLAGS = @SUDO_LDFLAGS@
VISUDO_LDFLAGS = @VISUDO_LDFLAGS@

# Where to install things...
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
sysconfdir = @sysconfdir@
mandir = @mandir@

# Directory in which to install sudo.
sudodir = $(bindir)

# Directory in which to install visudo
visudodir = $(sbindir)

# Directory in which to install the sudoers file
sudoersdir = $(sysconfdir)

# Directory in which to install the man page
# set mansect5 to 4 on sysV machines.
mantype = @MANTYPE@
mansect8 = 8
mansect5 = 5
mandir8 = $(mandir)/$(mantype)$(mansect8)
mandir5 = $(mandir)/$(mantype)$(mansect5)

# User and Group the installed file should be owned by
owner = root
group = staff

# See options.h and OPTIONS for a list of options
OPTIONS = @OPTIONS@ -D_PATH_SUDO_SUDOERS=\"$(sudoersdir)/sudoers\" -D_PATH_SUDO_STMP=\"$(sudoersdir)/stmp\" -DSUDOERS_OWNER=\"$(owner)\"

#### End of system configuration section. ####

SHELL = /bin/sh

PROGS = @PROGS@

SRCS = check.c sudo_getpwuid.c find_path.c logging.c parse.c sudo.c \
       goodpath.c sudo_setenv.c parse.yacc parse.lex visudo.c interfaces.c

PARSEOBJS = y.tab.o lex.yy.o

SUDOBJS = check.o sudo_getpwuid.o find_path.o logging.o parse.o sudo.o \
          goodpath.o sudo_setenv.o interfaces.o @DCE_OBJS@

VISUDOBJS = visudo.o

TESTOBJS = interfaces.o testsudoers.o

LIBOBJS = @TGETPASS@ @LIBOBJS@

HDRS = sudo.h pathnames.h options.h compat.h version.h insults.h \
       ins_2001.h ins_classic.h ins_goons.h ins_csops.h

VERSION = 1.3.6

DISTFILES = $(SRCS) $(HDRS) BUGS CHANGES COPYING HISTORY INSTALL OPTIONS TODO \
            PORTING README RUNSON TROUBLESHOOTING Makefile.in acsite.m4 \
            aixcrypt.exp config.h.in configure configure.in getwd.c strdup.c \
            indent.pro install-sh lsearch.c putenv.c tgetpass.c emul/search.h \
	    emul/utime.h utime.c testsudoers.c sudoers sample.sudoers \
	    sudo.cat sudo.man visudo.cat visudo.man sudoers.cat sudoers.man \
	    lex.yy.c sudo-lex.yy.c dce_pwent.c

all: $(PROGS)

.SUFFIXES: .o .c .h .lex .yacc .man .cat

.c.o:
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(OSDEFS) $(OPTIONS) $<

.man.cat:
	$(NROFF) -man $< > $@

sudo: $(PARSEOBJS) $(SUDOBJS) $(LIBOBJS)
	$(CC) -o $@ $(PARSEOBJS) $(SUDOBJS) $(LIBOBJS) $(SUDO_LDFLAGS) $(SUDO_LIBS)

visudo: $(PARSEOBJS) $(VISUDOBJS)
	$(CC) -o $@ $(PARSEOBJS) $(VISUDOBJS) $(LIBOBJS) $(VISUDO_LDFLAGS) $(VISUDO_LIBS)

testsudoers: $(PARSEOBJS) $(TESTOBJS)
	$(CC) -o $@ $(PARSEOBJS) $(TESTOBJS) $(VISUDO_LDFLAGS) $(VISUDO_LIBS)

y.tab.c y.tab.h: parse.yacc
	$(YACC) -d $(srcdir)/parse.yacc

y.tab.o: $(HDRS) y.tab.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(OSDEFS) $(OPTIONS) y.tab.c

lex.yy.c: parse.lex
	rm -f lex.yy.c
	$(LEX) $(srcdir)/parse.lex

lex.yy.o: lex.yy.c y.tab.h $(HDRS)

$(SUDOBJS) $(LIBOBJS) : $(HDRS) config.h

sudo.cat: $(srcdir)/sudo.man

visudo.cat: $(srcdir)/visudo.man

install: install-binaries install-sudoers install-man

install-binaries: $(PROGS)
	$(INSTALL) -o $(owner) -g $(group) -m 4111 -s sudo $(sudodir)/sudo
	$(INSTALL) -o $(owner) -g $(group) -m 0111 -s visudo $(visudodir)/visudo

install-sudoers:
	@ if [ -f $(sudoersdir)/sudoers ]; then  \
	    echo "Will not overwrite existing $(sudoersdir)/sudoers file."; \
	else \
	    $(INSTALL) -o $(owner) -g $(group) -m 0400 $(srcdir)/sudoers $(sudoersdir)/sudoers; \
	fi

install-man:
	$(INSTALL) -o $(owner) -g $(group) -m 0644 $(srcdir)/sudo.$(mantype) $(mandir8)/sudo.$(mansect8)
	$(INSTALL) -o $(owner) -g $(group) -m 0644 $(srcdir)/visudo.$(mantype) $(mandir8)/visudo.$(mansect8)
	$(INSTALL) -o $(owner) -g $(group) -m 0644 $(srcdir)/sudoers.$(mantype) $(mandir5)/sudoers.$(mansect5)
@MAN_POSTINSTALL@

tags: $(SRCS)
	ctags $(SRCS)

TAGS: $(SRCS)
	etags $(SRCS)

clean:
	-rm -f y.tab.[ch] *.o $(PROGS) testsudoers core

mostlyclean: clean

distclean: clean
	rm -f Makefile config.h config.status config.cache config.log

clobber: distclean

realclean: distclean
	rm -f TAGS tags

dist: $(DISTFILES)
	rm -f ../cu-sudo.v$(VERSION).tar.Z
	( cd .. ; TF="/tmp/sudo.dist$$$$" ; rm -f $$TF ; for i in $(DISTFILES) ; \
	  do echo sudo.v$(VERSION)/$$i >> $$TF ; done ; \
	  tar cf cu-sudo.v$(VERSION).tar \
	  `cat $$TF` && compress cu-sudo.v$(VERSION).tar && rm -f $$TF)
	ls -l ../cu-sudo.v$(VERSION).tar.Z
